
name: Mock Deployment

permissions:
  contents: write
  deployments: write

on:
  push:
    branches:
      - main
      - release/*
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or tag to deploy (e.g., main or v1.2.3)'
        required: false
        default: ''
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'staging' }}

    steps:
      - name: Determine ref
        id: ref
        shell: bash
        run: |
          if [ -n "${{ github.event.inputs.ref }}" ]; then
            echo "REF=${{ github.event.inputs.ref }}" >> $GITHUB_ENV
          else
            echo "REF=${{ github.ref_name }}" >> $GITHUB_ENV
          fi

          # If ref looks like a tag (v*)
          if [[ "${REF}" == v* ]]; then
            echo "TAG_NAME=${REF}" >> $GITHUB_ENV
          else
            echo "TAG_NAME=" >> $GITHUB_ENV
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.REF }}

      - name: Mock deploy
        shell: bash
        run: |
          echo "Simulating deployment for ${REF} in environment ${{ inputs.environment || 'staging' }}"
          sleep 2

      - name: Attach Tag Metadata to Deployment
        if: always()
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the latest deployment for this environment
          DEPLOYMENT_URL="${{ github.api_url }}/repos/${{ github.repository }}/deployments"
          DEPLOYMENT_ID=$(gh api "$DEPLOYMENT_URL" --jq '.[0].id')

          echo "Deployment ID: $DEPLOYMENT_ID"
          echo "Tag: $TAG_NAME"

          DESC="Deployed ref: ${REF}"
          if [ -n "$TAG_NAME" ]; then
            DESC="${DESC} (tag: ${TAG_NAME})"
          fi

          gh api "$DEPLOYMENT_URL/$DEPLOYMENT_ID/statuses" \
            -f state=success \
            -f description="$DESC" \
            -f environment="${{ inputs.environment || 'staging' }}" \
            -f log_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            -f auto_inactive=true
